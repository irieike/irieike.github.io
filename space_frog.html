<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RUDEBOY — Space Field (Frogs)</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    .hint{
      position:fixed;left:12px;bottom:12px;color:#bbb;
      font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;opacity:.9
    }
    .hint b{color:#fff}
  </style>

  <!-- Import map for CDN modules -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div class="hint">
    <b>R</b> autorotate • <b>B</b> bloom • <b>F</b> fly mode (WASD, drag-to-look)
  </div>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
    import { FlyControls } from "three/examples/jsm/controls/FlyControls.js";
    import { RoomEnvironment } from "three/examples/jsm/environments/RoomEnvironment.js";
    import { EffectComposer } from "three/examples/jsm/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/examples/jsm/postprocessing/RenderPass.js";
    import { UnrealBloomPass } from "three/examples/jsm/postprocessing/UnrealBloomPass.js";
    

    // --- Renderer ---
    const renderer = new THREE.WebGLRenderer({ antialias:true, powerPreference:"high-performance" });
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.2;
    document.body.appendChild(renderer.domElement);

    // --- Scene / Camera ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(0, 0.6, 10);

    // --- Environment reflections (no HDR files) ---
    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(renderer), 0.04).texture;

    // --- Lights (subtle; env does most of the work) ---
    const key = new THREE.DirectionalLight(0xffffff, 1.0); key.position.set(5,6,4); scene.add(key);
    const rim = new THREE.DirectionalLight(0xff6a00, 0.6); rim.position.set(-6,2,-4); scene.add(rim);
    const back = new THREE.DirectionalLight(0x88aaff, 0.4); back.position.set(0,-2,-4); scene.add(back);

    // --- Starfield backdrop ---
    (function makeStars(){
      const N = 2000, R = 160;
      const pos = new Float32Array(N*3);
      for (let i=0;i<N;i++){
        const u=Math.random(), v=Math.random();
        const th=2*Math.PI*u, ph=Math.acos(2*v-1);
        pos[i*3+0]=R*Math.sin(ph)*Math.cos(th);
        pos[i*3+1]=R*Math.sin(ph)*Math.sin(th);
        pos[i*3+2]=R*Math.cos(ph);
      }
      const geo = new THREE.BufferGeometry();
      geo.setAttribute("position", new THREE.BufferAttribute(pos,3));
      const mat = new THREE.PointsMaterial({ size:0.65, sizeAttenuation:true, color:0x9aa3ff, transparent:true, opacity:0.8 });
      scene.add(new THREE.Points(geo, mat));
    })();

    // --- Shader Sun (replaces previous simple sun/moon) ---
    let sunGroup = null; let sunUniforms = null;
    const sunFrag = `
uniform float time;
uniform sampler2D texture1;
uniform sampler2D texture2;
varying vec2 vUv;
void main(void){
  vec4 noise = texture2D(texture1, vUv);
  vec2 T1 = vUv + vec2(1.5, -1.5) * time * 0.01;
  vec2 T2 = vUv + vec2(-0.5, 2.0) * time * 0.01;
  T1.x -= noise.r * 2.0;
  T1.y += noise.g * 4.0;
  T2.x += noise.g * 0.2;
  T2.y += noise.b * 0.2;
  float p = texture2D(texture1, T1 * 2.0).a + 0.25;
  vec4 color = texture2D(texture2, T2);
  vec4 temp = color * 2.0 * vec4(p,p,p,p) + (color * color);
  gl_FragColor = temp;
}`;
    const sunVert = `
varying vec2 vUv;
void main(){
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
}`;
    function loadTex(url){
      return new Promise(res=> new THREE.TextureLoader().load(url, tex=>{ tex.wrapS = tex.wrapT = THREE.RepeatWrapping; res(tex); }));
    }
    (async function addShaderSun(){
      const [tex1, tex2] = await Promise.all([
        loadTex('https://s3-us-west-2.amazonaws.com/s.cdpn.io/297733/sunAtmosphereMaterial.png'),
        loadTex('https://s3-us-west-2.amazonaws.com/s.cdpn.io/297733/sunSurfaceMaterial.jpg')
      ]);
      sunUniforms = { time:{ value:1.0 }, texture1:{ value: tex1 }, texture2:{ value: tex2 } };
      const mat = new THREE.ShaderMaterial({ uniforms: sunUniforms, vertexShader: sunVert, fragmentShader: sunFrag });
      const geo = new THREE.SphereGeometry(12, 96, 64);
      const mesh = new THREE.Mesh(geo, mat);
      const light = new THREE.PointLight(0xffffff, 1.2, 1000);
      sunGroup = new THREE.Group();
      sunGroup.add(mesh); sunGroup.add(light);
      sunGroup.position.set(-50, 30, -100);
      scene.add(sunGroup);
    })();

    // --- Postprocessing (bloom, starts OFF) ---
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 1.05, 0.6, 0.12);
    composer.addPass(bloom);
    bloom.strength = 0; // keep bloom but disable at start

    // --- Controls ---
    const orbit = new OrbitControls(camera, renderer.domElement);
    orbit.enableDamping = true;
    orbit.enablePan = false;
    orbit.autoRotate = true;
    orbit.autoRotateSpeed = 0.45;
    orbit.minDistance = 4;
    orbit.maxDistance = 100;

    const fly = new FlyControls(camera, renderer.domElement);
    fly.enabled = false;          // off by default
    fly.movementSpeed = 10;       // WASD speed
    fly.rollSpeed = 0.8;          // QE speed
    fly.dragToLook = true;        // hold mouse to look
    fly.autoForward = false;

    function useOrbitMode(on){
      orbit.enabled = on;
      fly.enabled = !on;
    }
    useOrbitMode(true);

    // (Frogs removed)

    // --- Smooth camera flight (for Orbit mode) ---
    let camTween = null;
    function flyTo(targetPos, duration=1200){
      if (fly.enabled){
        const dir = targetPos.clone().sub(camera.position).normalize();
        camera.position.add(dir.multiplyScalar(5));
        return;
      }
      const startCam = camera.position.clone();
      const startTar = orbit.target.clone();
      const finalDist = 8;
      const dir = targetPos.clone().sub(startCam).normalize();
      const endTar = targetPos.clone();
      const endCam = targetPos.clone().add(dir.multiplyScalar(-finalDist));

      const start = performance.now();
      const ease = (t)=> t<0.5 ? 2*t*t : -1+(4-2*t)*t;
      camTween = function step(now){
        const p = Math.min(1, (now - start) / duration);
        const k = ease(p);
        camera.position.lerpVectors(startCam, endCam, k);
        orbit.target.lerpVectors(startTar, endTar, k);
        if (p < 1 && camTween) requestAnimationFrame(camTween);
        else camTween = null;
      };
      requestAnimationFrame(camTween);
    }

    // --- Animation / render ---
    const clock = new THREE.Clock();
    let started = false;
    function start(){
      if (started) return; started = true;
      renderer.setAnimationLoop(() => {
        const dt = clock.getDelta();

        // (no frogs to animate)

        if (sunGroup){ sunGroup.rotation.y += 0.001; if (sunUniforms) sunUniforms.time.value += dt; }

        if (orbit.enabled) orbit.update();
        if (fly.enabled)   fly.update(dt);

        composer.render();
      });
    }

    // --- Resize ---
    addEventListener("resize", () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      composer.setSize(innerWidth, innerHeight);
    });

    // --- Hotkeys ---
    addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if (k === "r") orbit.autoRotate = !orbit.autoRotate;
      if (k === "b") bloom.strength   = bloom.strength > 0 ? 0 : 1.05;
      if (k === "f") useOrbitMode(!fly.enabled);
    });
  </script>
</body>
</html>